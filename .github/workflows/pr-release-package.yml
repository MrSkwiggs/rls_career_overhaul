name: PR Release Package
on:
  pull_request:

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      has-changes: ${{ steps.check-changes.outputs.has-changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          lfs: true
      
      - name: Pull LFS
        run: git lfs pull
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: baseUI/package-lock.json
      
      - name: Merge and build
        run: |
          cp -r ui-vue-src/* baseUI/src/
          cd baseUI
          npm install
          npm run build
      
      - name: Move to final location
        run: |
          mkdir -p ui/vue-dist
          cp -r baseUI/dist/* ui/vue-dist/
      
      - name: Check for UI changes
        id: check-changes
        run: |
          if git diff --quiet HEAD -- ui/vue-dist/ 2>/dev/null; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "No UI changes detected"
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "UI changes detected"
          fi
  
  commit:
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.outputs.has-changes == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          lfs: true
      
      - name: Pull LFS
        run: git lfs pull
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: baseUI/package-lock.json
      
      - name: Merge and build
        run: |
          cp -r ui-vue-src/* baseUI/src/
          cd baseUI
          npm install
          npm run build
      
      - name: Move to final location
        run: |
          mkdir -p ui/vue-dist
          cp -r baseUI/dist/* ui/vue-dist/
      
      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update built UI files"
          file_pattern: ui/vue-dist/*
          branch: ${{ github.head_ref }}
  
  zip:
    needs: [build, commit]
    runs-on: ubuntu-latest
    if: always() && (needs.build.result == 'success' && (needs.commit.result == 'success' || needs.commit.result == 'skipped'))
    outputs:
      version: ${{ steps.version.outputs.version }}
      artifact-id: ${{ steps.get-artifact-id.outputs.id }}
      commit-status: ${{ needs.commit.result }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          lfs: true
      
      - name: Pull LFS
        run: git lfs pull
      
      - name: Calculate version and delete old artifacts
        id: version
        run: |
          PR_NUMBER="${{ github.event.number }}"
          PREFIX="rls_career_overhaul_PR_${PR_NUMBER}."
          
          ARTIFACTS_JSON=$(gh api repos/${{ github.repository }}/actions/artifacts --jq "[.artifacts[] | select(.name | startswith(\"$PREFIX\")) | {id: .id, name: .name}]" 2>/dev/null || echo "[]")
          
          ARTIFACT_COUNT=$(echo "$ARTIFACTS_JSON" | jq 'length')
          
          if [ "$ARTIFACT_COUNT" = "0" ] || [ -z "$ARTIFACTS_JSON" ] || [ "$ARTIFACTS_JSON" = "[]" ]; then
            MINOR_VERSION=1
            VERSION="${PR_NUMBER}.${MINOR_VERSION}"
            echo "No existing artifacts found, starting at version $VERSION"
          else
            echo "Found $ARTIFACT_COUNT existing artifact(s), finding max version..."
            MAX_MINOR=$(echo "$ARTIFACTS_JSON" | jq -r '.[].name' | sed "s/$PREFIX//" | sort -n | tail -1)
            if [ -z "$MAX_MINOR" ] || [ "$MAX_MINOR" = "null" ]; then
              MAX_MINOR=0
            fi
            
            echo "Deleting old artifacts (max version was $MAX_MINOR)..."
            echo "$ARTIFACTS_JSON" | jq -r '.[].id' | while read ARTIFACT_ID; do
              if [ -n "$ARTIFACT_ID" ] && [ "$ARTIFACT_ID" != "null" ]; then
                ARTIFACT_NAME=$(echo "$ARTIFACTS_JSON" | jq -r ".[] | select(.id == $ARTIFACT_ID) | .name")
                echo "Deleting artifact: $ARTIFACT_NAME (ID: $ARTIFACT_ID)"
                gh api repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID -X DELETE || true
              fi
            done
            
            MINOR_VERSION=$((MAX_MINOR + 1))
            VERSION="${PR_NUMBER}.${MINOR_VERSION}"
            echo "Calculated new version: $VERSION"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload mod directories as artifact
        uses: actions/upload-artifact@v4
        with:
          name: rls_career_overhaul_PR_${{ steps.version.outputs.version }}
          path: |
            challenges/
            gameplay/
            levels/
            lua/
            mod_info/
            scripts/
            ui/
            vehicles/
          retention-days: 7
          if-no-files-found: error
      
      - name: Get artifact ID
        id: get-artifact-id
        run: |
          sleep 2
          ARTIFACT_NAME="rls_career_overhaul_PR_${{ steps.version.outputs.version }}"
          ARTIFACT_ID=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts --jq ".artifacts[] | select(.name == \"$ARTIFACT_NAME\") | .id" || echo "")
          if [ -z "$ARTIFACT_ID" ]; then
            echo "Warning: Could not find artifact ID, falling back to workflow run URL"
            echo "id=" >> $GITHUB_OUTPUT
          else
            echo "id=$ARTIFACT_ID" >> $GITHUB_OUTPUT
            echo "Found artifact ID: $ARTIFACT_ID"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  comment:
    needs: zip
    runs-on: ubuntu-latest
    if: always() && needs.zip.result == 'success'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Comment PR with download link
        run: |
          VERSION="${{ needs.zip.outputs.version }}"
          ARTIFACT_ID="${{ needs.zip.outputs.artifact-id }}"
          
          if [ -n "$ARTIFACT_ID" ]; then
            DOWNLOAD_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/$ARTIFACT_ID"
          else
            DOWNLOAD_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
          
          MESSAGE="[Zipped Overhaul PR v$VERSION]($DOWNLOAD_URL)"
          
          gh pr comment ${{ github.event.number }} --body "$MESSAGE"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
